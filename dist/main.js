(()=>{var e={29:e=>{"use strict";e.exports=require("unzipper")},317:e=>{"use strict";e.exports=require("child_process")},482:e=>{"use strict";e.exports=require("electron")},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")}},o={};function s(t){var n=o[t];if(void 0!==n)return n.exports;var r=o[t]={exports:{}};return e[t](r,r.exports,s),r.exports}const{app:t,BrowserWindow:n,Menu:r,ipcMain:c,dialog:a}=s(482),{execSync:i,exec:l}=s(317),d=s(928),h=s(29),p=s(896),g=d.join(t.getPath("userData"),"config.json"),m=function(){try{if(p.existsSync(g))return JSON.parse(p.readFileSync(g,"utf8"))}catch(e){console.error("Failed to load config:",e)}return{}}();console.log(g,m);let u=m&&!0===m.optionOsHdc?`"${S()}"`:`"${x()}"`;console.log("hdcPath:",u);const w=`"${function(){let e;e=d.join(process.resourcesPath,"hdc");const o=process.platform;if("win32"===o)return d.join(e,"win","adb.exe");if("darwin"===o)return"arm64"===process.arch?d.join(e,"mac/arm64","adb"):d.join(e,"mac/x64","adb");throw new Error(`不支持的平台: ${o}`)}()}"`,$="com.sohu.sohuvideoharmony";let f="";function b(){const e=new n({width:800,height:600,icon:d.join(process.resourcesPath,"./public/logo.ico"),webPreferences:{backgroundThrottling:!1,webviewTag:!0,webSecurity:!1,preload:d.join(__dirname,"preload.js"),nodeIntegration:!0}});r.setApplicationMenu(null),console.log("__dirname: ",__dirname),e.loadFile(d.join(__dirname,"./index.html")),e.on("ready-to-show",(()=>{e.show(),e.focus()})),e.on("closed",(()=>{})),e.webContents.on("did-finish-load",(()=>{e.webContents.send("load-config",m)})),c.handle("save-config",(async(e,o)=>{try{p.writeFileSync(g,JSON.stringify(o,null,2)),u=!0===o.optionOsHdc?S():x()}catch(e){console.error("Failed to save config:",e)}})),c.handle("dialog:openFile",(async()=>{const{canceled:o,filePaths:s}=await a.showOpenDialog(e,{properties:["openFile"],filters:[{name:"HarmonyPackage",extensions:["app","hap"]}]});if(!o)return s[0]})),c.handle("check-hdc",(async()=>{try{e.webContents.send("hdc-status","正在检查 hdc 环境变量...");const o=i(`${u} -v`);console.log(o.toString()),console.log("hdc is ok"),e.webContents.send("hdc-status",{message:"hdc is ok"})}catch(o){console.error(`命令执行错误: ${o}`),e.webContents.send("hdc-status",{message:"error: 检查 hdc 环境变量."})}})),c.handle("install-app",(async(o,s,t)=>{try{e.webContents.send("hdc-status",{message:"开始安装应用..."}),function(e){console.log("stop app."),i(`${u} shell aa force-stop ${$}`),e&&(console.log("uninstall..."),i(`${u} uninstall ${$}`))}(t);const o=d.dirname(s);if(s.endsWith(".app")){const t=d.basename(s,".app"),n=d.join(o,`${t}.zip`);p.renameSync(s,n),p.createReadStream(n).pipe(h.Extract({path:o})).on("close",(()=>{console.log("解压完成！"),p.renameSync(n,s);const o=s.replace(".app","");y(e,o)})).on("error",(o=>{console.error("解压过程中发生错误:",o),p.renameSync(n,s),e.webContents.send("hdc-status",{message:`error: 解压过程中发生错误: ${o}`})}))}else if(s.endsWith(".hap")){const t=`${o}/tmp_${d.basename(s,".hap")}`;console.log("tmpDirPath:",t);const n=d.join(t,d.basename(s));p.mkdirSync(t),p.cpSync(s,n),y(e,t)}}catch(o){console.error(`命令执行错误: ${o}`),e.webContents.send("hdc-status",{message:`error: 安装失败，${o}`})}})),c.handle("hdc-snapshot",(async()=>{try{const o=i(`${u} list targets | head -n 1`).toString().trim().replace(/[\n\r]/g,""),s=i(`${u}  -t ${o} shell snapshot_display`).toString();console.log(s);const n=/success:\s+.+?write to\s+([^\s]+)/,r=s.match(n);if(r&&r[0]){const o=r[0],s=t.getPath("desktop");i(`${u} file recv ${o} ${s}`),e.webContents.send("hdc-status",{message:`截屏已发送到桌面 > ${d.basename(o)}`,animate:!0})}}catch(o){console.error(`命令执行错误: ${o}`),e.webContents.send("hdc-status",{message:"error: 检查 hdc 环境变量."})}})),c.handle("hdc-start-record",(async()=>{try{f=`sohu_${Date.now()}.mp4`;const e=i(`${u} list targets | head -n 1`).toString().trim().replace(/[\n\r]/g,"");l(`${u} -t ${e} shell aa start -b com.huawei.hmos.screenrecorder -a com.huawei.hmos.screenrecorder.ServiceExtAbility --ps "CustomizedFileName" ${f}`,((e,o,s)=>{const t=o.toString();console.log(t)}))}catch(o){console.error(`命令执行错误: ${o}`),e.webContents.send("hdc-status",{message:"error: 检查 hdc 环境变量."})}})),c.handle("hdc-stop-record",(async()=>{try{console.log(`hdc-stop-record: ${f}`),l(`${u} shell aa start -b com.huawei.hmos.screenrecorder -a com.huawei.hmos.screenrecorder.ServiceExtAbility`,((e,o,s)=>{const n=o.toString();console.log(n);const r=i(`${u} shell mediatool query ${f} -u`).toString().match(/(file:\/\/[^"\s]+)/);let c="";if(r&&r[1]){c=r[1],console.log("提取的文件位置：",c);const e=i(`${u} shell mediatool recv ${c} /data/local/tmp`).toString();console.log(e);const o=/\/data\/local\/tmp\/sohu_.*\.mp4/,s=e.match(o);if(console.log(s[0]),s&&s[0]&&(c=s[0]),c){const e=t.getPath("desktop");i(`${u} file recv ${c} ${e}`)}}}))}catch(o){console.error(`命令执行错误: ${o}`),e.webContents.send("hdc-status",{message:"error: 检查 hdc 环境变量."})}})),c.handle("adb-snapshot",(async()=>{try{const o=`snapshot_${Date.now()}.png`,s=i(`${w} shell screencap -p /data/local/tmp/${o}`);console.log(s.toString());const n=t.getPath("desktop"),r=i(`${w} pull /data/local/tmp/${o} ${n}`);console.log(r.toString()),e.webContents.send("hdc-status",{message:`截屏已发送到桌面 > ${o}`,animate:!0})}catch(o){console.error(`命令执行错误: ${o}`),e.webContents.send("hdc-status",{message:"error: 检查 adb 环境变量."})}}))}function y(e,o){console.log("send file.");const s=d.basename(o);e.webContents.send("hdc-status",{message:"send file."});const t=i(`${u} file send ${o} data/local/tmp/`);if(console.log(t.toString()),t.toString().indexOf("Fail")>-1)return void e.webContents.send("hdc-status",{message:"error: send file error."});console.log("install ..."),e.webContents.send("hdc-status",{message:"install ..."});const n=i(`${u} shell bm install -r -p data/local/tmp/${s}`);console.log(n.toString()),n.toString().indexOf("Fail")>-1?e.webContents.send("hdc-status",{message:"error: send file error."}):(i(`${u} shell aa start -a AppAbility -b ${$} -m app`),i(`${u} shell rm -rf data/local/tmp/${s}`),o&&p.existsSync(o)&&p.rm(o,{recursive:!0},((e,o)=>{})),console.log("app install finished."),e.webContents.send("hdc-status",{message:"app install finished."}))}function S(){let e="";try{if("win32"===process.platform){const o=i("where hdc",{stdio:"pipe"}).toString().trim();o&&p.existsSync(o)&&(e=o)}else e=i("which hdc",{stdio:"pipe"}).toString().trim()}catch(o){e=""}return e}function x(){let e;e=d.join(process.resourcesPath,"hdc");const o=process.platform;if("win32"===o)return d.join(e,"win","hdc.exe");if("darwin"===o)return"arm64"===process.arch?d.join(e,"mac/arm64","hdc"):d.join(e,"mac/x64","hdc");throw new Error(`不支持的平台: ${o}`)}t.allowRendererProcessReuse=!0,t.whenReady().then((()=>{console.log("whenready"),b()})),t.on("window-all-closed",(function(){console.log("window-all-closed"),"darwin"!==process.platform&&t.quit()})),t.on("activate",(function(){0===n.getAllWindows().length&&b()}))})();