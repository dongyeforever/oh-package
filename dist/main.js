(()=>{var e={29:e=>{"use strict";e.exports=require("unzipper")},236:e=>{"use strict";e.exports=require("console")},317:e=>{"use strict";e.exports=require("child_process")},482:e=>{"use strict";e.exports=require("electron")},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")}},o={};function n(s){var t=o[s];if(void 0!==t)return t.exports;var r=o[s]={exports:{}};return e[s](r,r.exports,n),r.exports}const{app:s,BrowserWindow:t,ipcMain:r,dialog:c}=n(482),{execSync:a}=n(317),i=n(928),l=n(29),d=n(896),{time:p}=n(236),h=`"${function(){let e;e=i.join(process.resourcesPath,"hdc");const o=process.platform;if("win32"===o)return i.join(e,"win","hdc.exe");if("darwin"===o)return"arm64"===process.arch?i.join(e,"mac/arm64","hdc"):i.join(e,"mac/x64","hdc");throw new Error(`不支持的平台: ${o}`)}()}"`;console.log("hdcPath:",h);const u="com.sohu.sohuvideoharmony";function w(){const e=new t({width:800,height:600,icon:i.join(process.resourcesPath,"./public/logo.ico"),webPreferences:{backgroundThrottling:!1,webviewTag:!0,webSecurity:!1,preload:i.join(__dirname,"preload.js"),nodeIntegration:!0}});console.log("__dirname: ",__dirname),console.log("process.env.NODE_ENV: ","production"),e.loadFile(i.join(__dirname,"./index.html")),e.on("ready-to-show",(()=>{e.show(),e.focus()})),e.on("closed",(()=>{})),r.handle("dialog:openFile",(async()=>{const{canceled:o,filePaths:n}=await c.showOpenDialog(e,{properties:["openFile"],filters:[{name:"HarmonyPackage",extensions:["app","hap"]}]});if(!o)return n[0]})),r.handle("check-hdc",(async()=>{try{e.webContents.send("hdc-status","正在检查 hdc 环境变量...");const o=a(`${h} -v`);console.log(o.toString()),console.log("hdc is ok"),e.webContents.send("hdc-status","hdc is ok")}catch(o){console.error(`命令执行错误: ${o}`),e.webContents.send("hdc-status","error: 检查 hdc 环境变量.")}})),r.handle("install-app",(async(o,n,s)=>{try{e.webContents.send("hdc-status","开始安装应用..."),function(e){console.log("stop app."),a(`${h} shell aa force-stop ${u}`),e&&(console.log("uninstall..."),a(`${h} uninstall ${u}`))}(s);const o=i.dirname(n);if(n.endsWith(".app")){const s=i.basename(n,".app"),t=i.join(o,`${s}.zip`);d.renameSync(n,t),d.createReadStream(t).pipe(l.Extract({path:o})).on("close",(()=>{console.log("解压完成！"),d.renameSync(t,n);const o=n.replace(".app","");m(e,o)})).on("error",(o=>{console.error("解压过程中发生错误:",o),d.renameSync(t,n),e.webContents.send("hdc-status",`error: 解压过程中发生错误: ${o}`)}))}else if(n.endsWith(".hap")){const s=`${o}/tmp_${i.basename(n,".hap")}`;console.log("tmpDirPath:",s);const t=i.join(s,i.basename(n));d.mkdirSync(s),d.cpSync(n,t),m(e,s)}}catch(o){console.error(`命令执行错误: ${o}`),e.webContents.send("hdc-status",`error: 安装失败，${o}`)}})),r.handle("hdc-snapshot",(async()=>{try{const e=a(`${h} shell snapshot_display`).toString();console.log(e);const o=/success:\s+.+?write to\s+([^\s]+)/,n=e.match(o);if(n&&n[1]){const e=n[1];a(`${h} file recv ${e} ~/Desktop/`)}}catch(o){console.error(`命令执行错误: ${o}`),e.webContents.send("hdc-status","error: 检查 hdc 环境变量.")}}))}function m(e,o){console.log("send file.");const n=i.basename(o);e.webContents.send("hdc-status","send file.");const s=a(`${h} file send ${o} data/local/tmp/`);if(console.log(s.toString()),s.toString().indexOf("Fail")>-1)return void e.webContents.send("hdc-status","error: send file error.");console.log("install ..."),e.webContents.send("hdc-status","install ...");const t=a(`${h} shell bm install -r -p data/local/tmp/${n}`);console.log(t.toString()),t.toString().indexOf("Fail")>-1?e.webContents.send("hdc-status","error: send file error."):(a(`${h} shell aa start -a AppAbility -b ${u} -m app`),a(`${h} shell rm -rf data/local/tmp/${n}`),o&&d.existsSync(o)&&d.rm(o,{recursive:!0},((e,o)=>{})),console.log("app install finished."),e.webContents.send("hdc-status","app install finished."))}s.allowRendererProcessReuse=!0,s.whenReady().then((()=>{console.log("whenready"),w()})),s.on("window-all-closed",(function(){console.log("window-all-closed"),"darwin"!==process.platform&&s.quit()})),s.on("activate",(function(){0===t.getAllWindows().length&&w()}))})();