(()=>{var e={29:e=>{"use strict";e.exports=require("unzipper")},317:e=>{"use strict";e.exports=require("child_process")},482:e=>{"use strict";e.exports=require("electron")},896:e=>{"use strict";e.exports=require("fs")},928:e=>{"use strict";e.exports=require("path")}},s={};function o(t){var n=s[t];if(void 0!==n)return n.exports;var r=s[t]={exports:{}};return e[t](r,r.exports,o),r.exports}const{app:t,BrowserWindow:n,Menu:r,ipcMain:c,dialog:a}=o(482),{execSync:i,exec:l}=o(317),d=o(928),h=o(29),p=o(896),g=d.join(t.getPath("userData"),"config.json"),m=function(){try{if(p.existsSync(g))return JSON.parse(p.readFileSync(g,"utf8"))}catch(e){console.error("Failed to load config:",e)}return{}}();console.log(g,m);let u=m&&!0===m.optionOsHdc?`"${S()}"`:`"${x()}"`;console.log("hdcPath:",u);const w=`"${function(){let e;e=d.join(process.resourcesPath,"hdc");const s=process.platform;if("win32"===s)return d.join(e,"win","adb.exe");if("darwin"===s)return"arm64"===process.arch?d.join(e,"mac/arm64","adb"):d.join(e,"mac/x64","adb");throw new Error(`不支持的平台: ${s}`)}()}"`,$="com.sohu.sohuvideoharmony";let f="";function b(){const e=new n({width:800,height:600,icon:d.join(process.resourcesPath,"./public/logo.ico"),webPreferences:{backgroundThrottling:!1,webviewTag:!0,webSecurity:!1,preload:d.join(__dirname,"preload.js"),nodeIntegration:!0}});r.setApplicationMenu(null),console.log("__dirname: ",__dirname),e.loadFile(d.join(__dirname,"./index.html")),e.on("ready-to-show",(()=>{e.show(),e.focus()})),e.on("closed",(()=>{})),e.webContents.on("did-finish-load",(()=>{e.webContents.send("load-config",m)})),c.handle("save-config",(async(e,s)=>{try{p.writeFileSync(g,JSON.stringify(s,null,2)),u=!0===s.optionOsHdc?S():x()}catch(e){console.error("Failed to save config:",e)}})),c.handle("dialog:openFile",(async()=>{const{canceled:s,filePaths:o}=await a.showOpenDialog(e,{properties:["openFile"],filters:[{name:"HarmonyPackage",extensions:["app","hap"]}]});if(!s)return o[0]})),c.handle("check-hdc",(async()=>{try{e.webContents.send("hdc-status","正在检查 hdc 环境变量...");const s=i(`${u} -v`);console.log(s.toString()),console.log("hdc is ok"),e.webContents.send("hdc-status",{message:"hdc is ok"})}catch(s){console.error(`命令执行错误: ${s}`),e.webContents.send("hdc-status",{message:"error: 检查 hdc 环境变量."})}})),c.handle("install-app",(async(s,o,t)=>{try{e.webContents.send("hdc-status",{message:"开始安装应用..."}),function(e){console.log("stop app."),i(`${u} shell aa force-stop ${$}`),e&&(console.log("uninstall..."),i(`${u} uninstall ${$}`))}(t);const s=d.dirname(o);if(o.endsWith(".app")){const t=d.basename(o,".app"),n=d.join(s,`${t}.zip`);p.renameSync(o,n),p.createReadStream(n).pipe(h.Extract({path:s})).on("close",(()=>{console.log("解压完成！"),p.renameSync(n,o);const s=o.replace(".app","");y(e,s)})).on("error",(s=>{console.error("解压过程中发生错误:",s),p.renameSync(n,o),e.webContents.send("hdc-status",{message:`error: 解压过程中发生错误: ${s}`})}))}else if(o.endsWith(".hap")){const t=`${s}/tmp_${d.basename(o,".hap")}`;console.log("tmpDirPath:",t);const n=d.join(t,d.basename(o));p.mkdirSync(t),p.cpSync(o,n),y(e,t)}}catch(s){console.error(`命令执行错误: ${s}`),e.webContents.send("hdc-status",{message:`error: 安装失败，${s}`})}})),c.handle("hdc-snapshot",(async()=>{try{const s=i(`${u} list targets | head -n 1`).toString().trim().replace(/[\n\r]/g,""),o=i(`${u}  -t ${s} shell snapshot_display`).toString();console.log(o);const n=/success:\s+.+?write to\s+([^\s]+)/,r=o.match(n);if(r&&r[0]){const s=r[0],o=t.getPath("desktop");i(`${u} file recv ${s} ${o}`),e.webContents.send("hdc-status",{message:`截屏已发送到桌面 > ${d.basename(s)}`,animate:!0})}}catch(s){console.error(`命令执行错误: ${s}`),e.webContents.send("hdc-status",{message:"error: 检查 hdc 环境变量."})}})),c.handle("hdc-start-record",(async()=>{try{f=`sohu_${Date.now()}.mp4`;const e=i(`${u} list targets | head -n 1`).toString().trim().replace(/[\n\r]/g,"");l(`${u} -t ${e} shell aa start -b com.huawei.hmos.screenrecorder -a com.huawei.hmos.screenrecorder.ServiceExtAbility --ps "CustomizedFileName" ${f}`,((e,s,o)=>{const t=s.toString();console.log(t)}))}catch(s){console.error(`命令执行错误: ${s}`),e.webContents.send("hdc-status",{message:"error: 检查 hdc 环境变量."})}})),c.handle("hdc-stop-record",(async()=>{try{console.log(`hdc-stop-record: ${f}`),l(`${u} shell aa start -b com.huawei.hmos.screenrecorder -a com.huawei.hmos.screenrecorder.ServiceExtAbility`,((e,s,o)=>{const n=s.toString();console.log(n);const r=i(`${u} shell mediatool query ${f}`).toString().match(/\/storage\/.*\.mp4/);if(console.log(r[0]),r&&r[0]){const e=r[0],s=t.getPath("desktop");i(`${u} file recv ${e} ${s}`)}}))}catch(s){console.error(`命令执行错误: ${s}`),e.webContents.send("hdc-status",{message:"error: 检查 hdc 环境变量."})}})),c.handle("adb-snapshot",(async()=>{try{const s=`snapshot_${Date.now()}.png`,o=i(`${w} shell screencap -p /data/local/tmp/${s}`);console.log(o.toString());const n=t.getPath("desktop"),r=i(`${w} pull /data/local/tmp/${s} ${n}`);console.log(r.toString()),e.webContents.send("hdc-status",{message:`截屏已发送到桌面 > ${s}`,animate:!0})}catch(s){console.error(`命令执行错误: ${s}`),e.webContents.send("hdc-status",{message:"error: 检查 adb 环境变量."})}}))}function y(e,s){console.log("send file.");const o=d.basename(s);e.webContents.send("hdc-status",{message:"send file."});const t=i(`${u} file send ${s} data/local/tmp/`);if(console.log(t.toString()),t.toString().indexOf("Fail")>-1)return void e.webContents.send("hdc-status",{message:"error: send file error."});console.log("install ..."),e.webContents.send("hdc-status",{message:"install ..."});const n=i(`${u} shell bm install -r -p data/local/tmp/${o}`);console.log(n.toString()),n.toString().indexOf("Fail")>-1?e.webContents.send("hdc-status",{message:"error: send file error."}):(i(`${u} shell aa start -a AppAbility -b ${$} -m app`),i(`${u} shell rm -rf data/local/tmp/${o}`),s&&p.existsSync(s)&&p.rm(s,{recursive:!0},((e,s)=>{})),console.log("app install finished."),e.webContents.send("hdc-status",{message:"app install finished."}))}function S(){let e="";try{if("win32"===process.platform){const s=i("where hdc",{stdio:"pipe"}).toString().trim();s&&p.existsSync(s)&&(e=s)}else e=i("which hdc",{stdio:"pipe"}).toString().trim()}catch(s){e=""}return e}function x(){let e;e=d.join(process.resourcesPath,"hdc");const s=process.platform;if("win32"===s)return d.join(e,"win","hdc.exe");if("darwin"===s)return"arm64"===process.arch?d.join(e,"mac/arm64","hdc"):d.join(e,"mac/x64","hdc");throw new Error(`不支持的平台: ${s}`)}t.allowRendererProcessReuse=!0,t.whenReady().then((()=>{console.log("whenready"),b()})),t.on("window-all-closed",(function(){console.log("window-all-closed"),"darwin"!==process.platform&&t.quit()})),t.on("activate",(function(){0===n.getAllWindows().length&&b()}))})();